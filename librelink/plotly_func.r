#: ----plotting----
# if input$date_range changes, that will trigger renderPlot again.
cgm_display(start = lubridate::as_datetime(input$date1), end = lubridate::as_datetime(input$date2), activity_df = activity_dt,
            glucose_df = glucose_dt, ref_band = glucose_ref_band)

p <- glucose_dt %>% plot_ly(., x = ~time, y = ~value, 
                       mode = "lines+markers", 
                       name = "cgm", 
                       type = "scatter",
                       color = I("gray60"))

p <- p %>% add_ribbons(., x = ~time, ymin = 100, ymax = 140, 
                  line = list(color = 'rgba(7, 164, 181, 0.05)'), # blue, use this ref website: https://convertingcolors.com/rgb-color-7_164_181.html
                  fillcolor = 'rgba(34, 139, 34, 0.2)',# forest green: 34,139,34
                  #color = I("green"), opacity = 0.1, 
                  inherit = FALSE,
                  name = "safe zone")

p <- p %>% add_ribbons(., x = ~time, ymin = 100, ymax = 140, 
                  line = list(color = 'rgba(7, 164, 181, 0.05)'), # blue, use this ref website: https://convertingcolors.com/rgb-color-7_164_181.html
                  fillcolor = 'rgba(34, 139, 34, 0.2)',# forest green: 34,139,34
                  #color = I("green"), opacity = 0.1, 
                  inherit = FALSE,
                  name = "safe zone")


geom_rect(data=activity_df %>% dplyr::filter(Activity == "Sleep") %>%
            select(xmin = Start,xmax = End) %>% cbind(ymin = -Inf, ymax = Inf),
          aes(xmin=xmin,xmax=xmax,ymin=ymin,ymax=ymax),
          fill="red",
          alpha=0.2,
          inherit.aes = FALSE) +
  geom_rect(data=activity_df %>% dplyr::filter(Activity == "Exercise") %>%
              select(xmin = Start,xmax = End),
            aes(xmin=xmin,xmax=xmax,ymin=-Inf,ymax=Inf),
            fill="blue",
            alpha=0.2,
            inherit.aes = FALSE) +
  geom_vline(xintercept = activity_df %>%
               dplyr::filter(Activity == "Event" & Comment == "awake") %>% select("Start") %>% unlist(),
             color = "green") +
  geom_vline(xintercept = activity_df %>%
               dplyr::filter(Activity == "Food") %>% select("Start") %>% unlist(),
             color = "yellow")+
  geom_text(data = activity_df %>%
              dplyr::filter(Activity == "Food") %>% select("Start","Comment") ,
            aes(x=Start,y=50, angle=90, hjust = FALSE,  label = Comment),
            size = 6) +
  labs(title = "Glucose (mg/dL)", subtitle = start) +  theme(plot.title = element_text(size=22))+
  scale_x_datetime(limits = c(start,end))


library(plotly)
trace1 <- list(
  x = c(0.0, 0.010101010101010102, 0.020202020202020204, 0.030303030303030304, 0.04040404040404041, 0.05050505050505051, 0.06060606060606061, 0.07070707070707072, 0.08080808080808081, 0.09090909090909091, 0.10101010101010102, 0.11111111111111112, 0.12121212121212122, 0.13131313131313133, 0.14141414141414144, 0.15151515151515152, 0.16161616161616163, 0.17171717171717174, 0.18181818181818182, 0.19191919191919193, 0.20202020202020204, 0.21212121212121213, 0.22222222222222224, 0.23232323232323235, 0.24242424242424243, 0.25252525252525254, 0.26262626262626265, 0.27272727272727276, 0.2828282828282829, 0.29292929292929293, 0.30303030303030304, 0.31313131313131315, 0.32323232323232326, 0.33333333333333337, 0.3434343434343435, 0.3535353535353536, 0.36363636363636365, 0.37373737373737376, 0.38383838383838387, 0.393939393939394, 0.4040404040404041, 0.4141414141414142, 0.42424242424242425, 0.43434343434343436, 0.4444444444444445, 0.4545454545454546, 0.4646464646464647, 0.4747474747474748, 0.48484848484848486, 0.494949494949495, 0.5050505050505051, 0.5151515151515152, 0.5252525252525253, 0.5353535353535354, 0.5454545454545455, 0.5555555555555556, 0.5656565656565657, 0.5757575757575758, 0.5858585858585859, 0.595959595959596, 0.6060606060606061, 0.6161616161616162, 0.6262626262626263, 0.6363636363636365, 0.6464646464646465, 0.6565656565656566, 0.6666666666666667, 0.6767676767676768, 0.686868686868687, 0.696969696969697, 0.7070707070707072, 0.7171717171717172, 0.7272727272727273, 0.7373737373737375, 0.7474747474747475, 0.7575757575757577, 0.7676767676767677, 0.7777777777777778, 0.787878787878788, 0.797979797979798, 0.8080808080808082, 0.8181818181818182, 0.8282828282828284, 0.8383838383838385, 0.8484848484848485, 0.8585858585858587, 0.8686868686868687, 0.8787878787878789, 0.888888888888889, 0.8989898989898991, 0.9090909090909092, 0.9191919191919192, 0.9292929292929294, 0.9393939393939394, 0.9494949494949496, 0.9595959595959597, 0.9696969696969697, 0.9797979797979799, 0.98989898989899, 1.0), 
  y = c(4.432335719841239, 5.4375225934960065, 5.7408861101752215, 4.987452691093418, 4.036932509085493, 4.037381290800392, 7.0140977828929625, 5.050385646300194, 5.805347083481181, 4.295297503050996, 5.289709240104057, 7.255165044398003, 5.047057697939742, 5.465525651033383, 3.858385784348837, 3.045224199456807, 5.422014842486557, 3.3956208198682187, 5.03503162828556, 4.647967283281491, 5.849750403467366, 5.087569031146248, 3.1347359605740555, 3.541462671266638, 6.4102571225306155, 2.9654366430191983, 5.121444774285525, 3.977230593600211, 5.2446608655360345, 3.66531951022054, 4.904249584729328, 4.55476535258688, 4.8805593329377395, 5.8205880316066265, 5.837486151075121, 4.0850767941311865, 5.847169891052066, 5.262370679973621, 4.498922724506824, 3.8903214768227836, 4.348065138605731, 2.7520184052932484, 5.026528595010826, 5.038649708955531, 6.017399356131909, 5.447882092444893, 3.927381314123926, 4.371551354745399, 6.407540029753786, 4.256344446932936, 5.190855540207143, 5.741940401208581, 4.727954549605618, 5.434402377083305, 5.573990578873526, 5.2251330061068035, 5.900634317250457, 5.369969219909332, 6.215087220511781, 4.877265892375964, 4.614871511809178, 4.736172622409199, 5.134321008838346, 2.692191324430847, 6.518687625811205, 4.395832399909347, 5.062902938842864, 5.492672394106742, 3.7154817314405837, 4.851602736573374, 4.628892487732717, 5.435040684844192, 6.514279083402745, 5.584957298969755, 5.238536788230518, 6.206388027920591, 6.62344085139672, 5.166107375631087, 2.5845795128603073, 4.6798020766712, 5.840893467356957, 5.205190602887668, 5.603661821265238, 5.189795127308383, 5.177044809296995, 5.030943035902577, 3.708426329844815, 4.533767006846638, 4.41133944632743, 4.251386361927614, 4.547477498185208, 5.21616219649751, 7.066187741999846, 5.813669407760292, 5.61141679431175, 5.725267203586748, 6.363809874704277, 5.164197936055018, 3.887803489304225, 4.361477097443087), 
  mode = "lines", 
  name = "lines", 
  type = "scatter"
)
trace2 <- list(
  x = c(0.0, 0.010101010101010102, 0.020202020202020204, 0.030303030303030304, 0.04040404040404041, 0.05050505050505051, 0.06060606060606061, 0.07070707070707072, 0.08080808080808081, 0.09090909090909091, 0.10101010101010102, 0.11111111111111112, 0.12121212121212122, 0.13131313131313133, 0.14141414141414144, 0.15151515151515152, 0.16161616161616163, 0.17171717171717174, 0.18181818181818182, 0.19191919191919193, 0.20202020202020204, 0.21212121212121213, 0.22222222222222224, 0.23232323232323235, 0.24242424242424243, 0.25252525252525254, 0.26262626262626265, 0.27272727272727276, 0.2828282828282829, 0.29292929292929293, 0.30303030303030304, 0.31313131313131315, 0.32323232323232326, 0.33333333333333337, 0.3434343434343435, 0.3535353535353536, 0.36363636363636365, 0.37373737373737376, 0.38383838383838387, 0.393939393939394, 0.4040404040404041, 0.4141414141414142, 0.42424242424242425, 0.43434343434343436, 0.4444444444444445, 0.4545454545454546, 0.4646464646464647, 0.4747474747474748, 0.48484848484848486, 0.494949494949495, 0.5050505050505051, 0.5151515151515152, 0.5252525252525253, 0.5353535353535354, 0.5454545454545455, 0.5555555555555556, 0.5656565656565657, 0.5757575757575758, 0.5858585858585859, 0.595959595959596, 0.6060606060606061, 0.6161616161616162, 0.6262626262626263, 0.6363636363636365, 0.6464646464646465, 0.6565656565656566, 0.6666666666666667, 0.6767676767676768, 0.686868686868687, 0.696969696969697, 0.7070707070707072, 0.7171717171717172, 0.7272727272727273, 0.7373737373737375, 0.7474747474747475, 0.7575757575757577, 0.7676767676767677, 0.7777777777777778, 0.787878787878788, 0.797979797979798, 0.8080808080808082, 0.8181818181818182, 0.8282828282828284, 0.8383838383838385, 0.8484848484848485, 0.8585858585858587, 0.8686868686868687, 0.8787878787878789, 0.888888888888889, 0.8989898989898991, 0.9090909090909092, 0.9191919191919192, 0.9292929292929294, 0.9393939393939394, 0.9494949494949496, 0.9595959595959597, 0.9696969696969697, 0.9797979797979799, 0.98989898989899, 1.0), 
  y = c(0.3189127915151857, 0.2438545587666688, -0.17458823440146745, -0.48413829679298576, -0.830439277474883, -0.06777660383930932, 0.35668608665986223, -0.6002766883162255, 0.4385514718194272, -1.8076245180397843, 0.19739170679931958, 2.501248671802486, 2.15676690728703, 0.3760973351698476, -1.5379249181514671, -0.594945422818747, -0.03769772518549278, -0.5742158365612663, -0.013495829058975855, 1.0198204262877157, -0.6756632102659864, -2.0822397590530146, -2.1394858656046507, 0.07705842623866395, -1.4935734854715206, 0.6361562824587443, -0.06737478009852658, 1.6535809718717012, -0.04863600845838913, -1.2517792657527516, -0.16573807141854477, 1.936368790684476, -0.6390911376250946, -0.012094768106180872, 0.7369926397655407, 2.103526231496113, -0.8324265823821528, 0.1472422618013095, -0.2909310420994721, -0.6449578653712794, -0.2977593677107535, -0.8925542417656177, 1.111298321125626, 2.059395035807769, -1.2274487700263972, -0.3198569891077555, -0.37153870965890434, 0.03843985974610692, 0.4427619174905151, -0.27414950618661355, -0.5178077548615395, 1.2519973886628517, -0.5587587934664066, -1.4949627053747772, 1.033406037713281, 0.3431171830459086, 0.2512743216032402, 0.6169560410489335, -1.032628509667259, -2.161725398707249, -1.1257886357728508, -0.8062329041030396, 1.2695620707804804, 0.04436487792490884, -0.5726371905535088, 1.1117230595448953, -0.839333040228831, 1.4645624229411445, 1.232779098518508, -1.0614302480742122, 1.2985735587665213, -0.2016539862906046, -1.216838864145667, 0.32419090965215935, -1.7829074281222381, -1.1656547083752293, 1.9989114064877147, -0.23335958445101387, 0.5613069907007523, 1.7285681627572729, 0.11974176028312583, 0.15633278040745788, -0.35550694528752486, -0.7912350683911351, 0.7000764912523894, -1.141314274375264, 2.0033172370632117, -0.3371123528115625, -0.7899324278665424, -1.265563873345807, 0.06257547572532504, -0.8072085146054384, 0.13771904334283694, 1.6581736820030806, 1.1041522437429714, 1.0559977322659557, 2.116759189633864, -2.741346567429425, 0.2680177387219323, -0.8313182500661708), 
  mode = "lines+markers", 
  name = "lines+markers", 
  type = "scatter"
)
trace3 <- list(
  x = c(0.0, 0.010101010101010102, 0.020202020202020204, 0.030303030303030304, 0.04040404040404041, 0.05050505050505051, 0.06060606060606061, 0.07070707070707072, 0.08080808080808081, 0.09090909090909091, 0.10101010101010102, 0.11111111111111112, 0.12121212121212122, 0.13131313131313133, 0.14141414141414144, 0.15151515151515152, 0.16161616161616163, 0.17171717171717174, 0.18181818181818182, 0.19191919191919193, 0.20202020202020204, 0.21212121212121213, 0.22222222222222224, 0.23232323232323235, 0.24242424242424243, 0.25252525252525254, 0.26262626262626265, 0.27272727272727276, 0.2828282828282829, 0.29292929292929293, 0.30303030303030304, 0.31313131313131315, 0.32323232323232326, 0.33333333333333337, 0.3434343434343435, 0.3535353535353536, 0.36363636363636365, 0.37373737373737376, 0.38383838383838387, 0.393939393939394, 0.4040404040404041, 0.4141414141414142, 0.42424242424242425, 0.43434343434343436, 0.4444444444444445, 0.4545454545454546, 0.4646464646464647, 0.4747474747474748, 0.48484848484848486, 0.494949494949495, 0.5050505050505051, 0.5151515151515152, 0.5252525252525253, 0.5353535353535354, 0.5454545454545455, 0.5555555555555556, 0.5656565656565657, 0.5757575757575758, 0.5858585858585859, 0.595959595959596, 0.6060606060606061, 0.6161616161616162, 0.6262626262626263, 0.6363636363636365, 0.6464646464646465, 0.6565656565656566, 0.6666666666666667, 0.6767676767676768, 0.686868686868687, 0.696969696969697, 0.7070707070707072, 0.7171717171717172, 0.7272727272727273, 0.7373737373737375, 0.7474747474747475, 0.7575757575757577, 0.7676767676767677, 0.7777777777777778, 0.787878787878788, 0.797979797979798, 0.8080808080808082, 0.8181818181818182, 0.8282828282828284, 0.8383838383838385, 0.8484848484848485, 0.8585858585858587, 0.8686868686868687, 0.8787878787878789, 0.888888888888889, 0.8989898989898991, 0.9090909090909092, 0.9191919191919192, 0.9292929292929294, 0.9393939393939394, 0.9494949494949496, 0.9595959595959597, 0.9696969696969697, 0.9797979797979799, 0.98989898989899, 1.0), 
  y = c(-4.951251443187488, -4.412904484012907, -5.77722381249967, -5.15913044807522, -6.377728644839432, -3.7534710707843697, -4.063993827475548, -5.86298501884qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq
  type = "scatter"
)
data <- list(trace1, trace2, trace3)
p <- plot_ly()
p <- add_trace(p, x=trace1$x, y=trace1$y, mode=trace1$mode, name=trace1$name, type=trace1$type)
p <- add_trace(p, x=trace2$x, y=trace2$y, mode=trace2$mode, name=trace2$name, type=trace2$type)
p <- add_trace(p, x=trace3$x, y=trace3$y, mode=trace3$mode, name=trace3$name, type=trace3$type)
p