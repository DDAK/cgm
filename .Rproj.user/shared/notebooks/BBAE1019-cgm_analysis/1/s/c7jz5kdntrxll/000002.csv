"0","# a handy ggplot object that draws a band through the ""healthy"" target zones across the width of any graph:"
"0","glucose_target_gg <-   geom_rect(aes(xmin=as.POSIXct(-Inf,  origin = ""1970-01-01""),"
"0","                xmax=as.POSIXct(Inf,  origin= ""1970-01-01""),"
"0","                ymin=100,ymax=140),"
"0","            alpha = 0.01, fill = ""#CCCCCC"","
"0","            inherit.aes = FALSE)"
"0","# show glucose levels between start and end times"
"0","cgm_display <- function(start=lubridate::now()-lubridate::hours(18),"
"0","                        end=now(),"
"0","                        activity_df=activity_raw,"
"0","                        glucose_df=glucose_raw) {"
"0","  ggplot(glucose_df ,aes(x=time,y=value)) + geom_line(size=2, color = ""red"")+ "
"0","  geom_point(stat = ""identity"", aes(x=time,y=strip), color = ""blue"")+"
"0","  glucose_target_gg + "
"0","  geom_rect(data=activity_df %>% dplyr::filter(Activity == ""Sleep"") %>%"
"0","              select(xmin = Start,xmax = End) %>% cbind(ymin = -Inf, ymax = Inf),"
"0","            aes(xmin=xmin,xmax=xmax,ymin=ymin,ymax=ymax),"
"0","            fill=""red"","
"0","            alpha=0.2,"
"0","            inherit.aes = FALSE) +"
"0","  geom_rect(data=activity_df %>% dplyr::filter(Activity == ""Exercise"") %>%"
"0","              select(xmin = Start,xmax = End),"
"0","            aes(xmin=xmin,xmax=xmax,ymin=-Inf,ymax=Inf),"
"0","            fill=""blue"","
"0","            alpha=0.2,"
"0","            inherit.aes = FALSE) +"
"0","   geom_vline(xintercept = activity_df %>% "
"0","               dplyr::filter(Activity == ""Event"" & Comment == ""awake"") %>% select(""Start"") %>% unlist(),"
"0","             color = ""green"") +"
"0","  geom_vline(xintercept = activity_df %>% "
"0","               dplyr::filter(Activity == ""Food"") %>% select(""Start"") %>% unlist(),"
"0","             color = ""yellow"")+"
"0","  geom_text(data = activity_df %>%"
"0","              dplyr::filter(Activity == ""Food"") %>% select(""Start"",""Comment"") ,"
"0","            aes(x=Start,y=50, angle=90, hjust = FALSE,  label = Comment),"
"0","            size = 6) +"
"0","  labs(title = ""Glucose (mg/dL)"", subtitle = start) +  theme(plot.title = element_text(size=22))+"
"0","    scale_x_datetime(limits = c(start,end),"
"0","                     date_labels = ""%m/%d %H:%M"","
"0","                     timezone = ""US/Pacific"")"
"0","  "
"0","}"
"0","# returns a dataframe giving all glucose values within ""timelength"" of a specific activity"
"0","food_effect <- function( foodlist = c(""Oatmeal"",""Oatmeal w cinnamon""), activity_df = activity_raw, glucose_df = glucose_raw, timelength = lubridate::hours(2)){"
"0","  #food_df <- activity_df %>% dplyr::filter(str_detect(str_to_lower(activity_df$Comment),pattern = foodname))"
"0","  food_df <- activity_df %>% dplyr::filter(Comment %in% foodlist)"
"0","  food_df$Comment <- paste0(food_df$Comment,rownames(food_df))"
"0","  food_df_interval <- interval(food_df$Start,food_df$Start + hours(1))"
"0","  food_glucose <- glucose_df %>% dplyr::filter(apply(sapply(glucose_df$time,function(x) x %within% food_df_interval),2,any))"
"0"," # food_glucose <- glucose_df %>% dplyr::filter(sapply(glucose_df$time,function(x) x %within% food_df_interval))"
"0","  f <- cbind(food_glucose[1,],experiment = ""test"")"
"0","  "
"0","  a = NULL"
"0","  "
"0","  for(i in food_df$Start){"
"0","    i_time <- as_datetime(i, tz = ""US/Pacific"")"
"0","    # < rbind(i,a)"
"0","    g <- glucose_df %>% dplyr::filter(time %within% interval(i_time - minutes(10), i_time + timelength))"
"0","    #print(g)"
"0","    p = match(as_datetime(i),food_df$Start)"
"0","    f <- rbind(f,cbind(g,experiment = food_df$Comment[p]))"
"0","  }"
"0","  foods_experiment <- f[-1,]"
"0","  foods_experiment"
"0","}"
